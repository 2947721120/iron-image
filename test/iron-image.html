<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
  <head>
    <title>iron-image</title>

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../test-fixture/test-fixture-mocha.js"></script>

    <link rel="import" href="../../polymer/polymer.html">
    <link rel="import" href="../../test-fixture/test-fixture.html">
    <link rel="import" href="../iron-image.html">

    <style is="custom-style">
      #fixed-width-container {
        width: 500px;
      }

      #fixed-width-container iron-image {
        width: 100%;
        --iron-image-width: 100%;
      }

      #fixed-height-container {
        height: 500px;
      }

      #fixed-height-container iron-image {
        height: 100%;
        --iron-image-height: 100%;
      }
    </style>
  </head>
  <body>
    <test-fixture id="TrivialImage">
      <template>
        <iron-image></iron-image>
      </template>
    </test-fixture>

    <div id="fixed-width-container"></div>
    <div id="fixed-height-container"></div>

    <script>
      suite('<iron-image>', function() {
        function randomImageUrl () {
          return '../demo/polymer.svg?' + Math.random();
        }

        var image;

        suite('basic behavior', function() {
          setup(function() {
            image = fixture('TrivialImage');
          });

          test('can load images given a src', function(done) {
            image.addEventListener('loaded-changed', function onLoadedChanged() {
              image.removeEventListener('loaded-changed', onLoadedChanged);

              try {
                expect(image.loaded).to.be.eql(true);
                done();
              } catch (e) {
                done(e);
              }
            });
            image.src = randomImageUrl();
          });

          test('will reload images when src changes', function(done) {
            var loadCount = 0;

            image.addEventListener('loaded-changed', function onLoadedChanged() {
              if (image.loaded === true) {
                loadCount++;

                if (loadCount === 2) {
                  done();
                } else {
                  image.src = randomImageUrl();
                  image.removeEventListener('loaded-changed', onLoadedChanged);
                }
              }
            });

            image.src = randomImageUrl();
          });
        });

        suite('--iron-image-width, --iron-image-height', function() {
          var image;
          var fixedWidthContainer;

          setup(function() {
            image = fixture('TrivialImage');

            fixedWidthContainer = document.getElementById('fixed-width-container');
            fixedHeightContainer = document.getElementById('fixed-height-container');
          });

          test('100% width image fills container', function(done) {
            fixedWidthContainer.appendChild(image);

            image.$.img.addEventListener('load', function onLoadedChanged(e) {
              image.$.img.removeEventListener('load', onLoadedChanged);
              Polymer.updateStyles();

              var containerRect = fixedWidthContainer.getBoundingClientRect();
              var ironImageRect = image.getBoundingClientRect();
              var wrappedImageRect = image.$.img.getBoundingClientRect();

              expect(containerRect.width).to.equal(500);
              expect(ironImageRect.width).to.equal(500);
              expect(wrappedImageRect.width).to.equal(500);

              fixedWidthContainer.removeChild(image);
              done();
            });

            image.src = randomImageUrl();
          });

          test('100% height image fills container', function(done) {
            fixedHeightContainer.appendChild(image);

            image.$.img.addEventListener('load', function onLoadedChanged(e) {
              image.$.img.removeEventListener('load', onLoadedChanged);
              Polymer.updateStyles();

              var containerRect = fixedHeightContainer.getBoundingClientRect();
              var ironImageRect = image.getBoundingClientRect();
              var wrappedImageRect = image.$.img.getBoundingClientRect();

              expect(containerRect.height).to.equal(500);
              expect(ironImageRect.height).to.equal(500);
              expect(wrappedImageRect.height).to.equal(500);

              fixedHeightContainer.removeChild(image);
              done();
            });

            image.src = randomImageUrl();
          });
        });
      });
    </script>
  </body>
</html>
